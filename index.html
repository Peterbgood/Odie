<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wiener Watch: Weight & Calorie Tracker</title>
    <style>
        :root {
            --primary: #008080;
            --secondary: #800080;
            --bg: #e0f2f1;
            --white: #fff;
            --danger: #d32f2f;
            --gray: #f4f4f4;
            --accent: #ff9800;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-container {
            background: var(--white);
            width: 100%;
            max-width: 450px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 20px;
            text-align: center;
        }

        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* iOS NO ZOOM FIX */
        input { font-size: 16px !important; }

        .status-card {
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .calories-big {
            font-size: 4rem;
            font-weight: bold;
            color: var(--secondary);
            margin: 0;
        }

        .over-limit { color: var(--danger); }

        .input-section {
            padding: 15px;
            background: var(--gray);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row { display: flex; gap: 8px; }
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
        }

        .weight-log-bar {
            background: #fff9f0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #ffe0b2;
            border-bottom: 1px solid #ffe0b2;
        }

        .weight-display {
            display: flex;
            flex-direction: column;
        }

        .weight-display span { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        .weight-display strong { font-size: 1.2rem; color: var(--accent); }

        .log-list {
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        ul { list-style: none; padding: 0; margin: 0; }
        li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .dog-track {
            height: 35px;
            background: #fdfdfd;
            position: relative;
            overflow: hidden;
            border-top: 1px solid #eee;
        }

        #runningDog {
            position: absolute;
            left: -60px;
            font-size: 24px;
            transition: left 2s linear;
        }

        .footer {
            padding: 15px;
            font-size: 0.7rem;
            text-align: center;
            color: #bbb;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1 style="margin:0">üå≠ Wiener Watch</h1>
        <div class="date-nav">
            <button class="nav-btn" onclick="shiftDate(-1)">‚ùÆ</button>
            <input type="date" id="datePicker" onchange="setDate(this.value)" style="color:black; background:white; border:none; padding:5px; border-radius:5px;">
            <button class="nav-btn" onclick="shiftDate(1)">‚ùØ</button>
        </div>
    </header>

    <div class="status-card">
        <p style="margin:0; font-size: 11px; font-weight:bold; color: var(--primary)">CALORIES REMAINING</p>
        <h2 id="calDisplay" class="calories-big">600</h2>
    </div>

    <div class="weight-log-bar">
        <div class="weight-display">
            <span id="weightLabel">Weight on this day</span>
            <strong id="weightVal">-- lbs</strong>
        </div>
        <button onclick="updateWeight()" style="background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; font-size:12px;">Log Weight</button>
    </div>

    <div class="input-section">
        <div class="row">
            <input type="text" id="foodName" placeholder="What did he eat?" autocomplete="off">
            <input type="number" id="foodCals" placeholder="Cals" inputmode="decimal" pattern="[0-9]*" style="max-width: 80px;">
        </div>
        <button class="add-btn" onclick="addEntry()">Add Treat</button>
    </div>

    <div class="log-list">
        <h4 style="margin: 0 0 10px 0; color: var(--secondary); font-size: 0.9rem;">Daily Log</h4>
        <ul id="listBody"></ul>
    </div>

    <div class="dog-track">
        <div id="runningDog">üå≠üêï</div>
    </div>

    <div class="footer">
        <span onclick="changeGoal()" style="text-decoration:underline">Change Daily Goal</span> | 
        <span onclick="clearEverything()" style="text-decoration:underline">Reset App</span>
    </div>
</div>

<script>
    const KEY = 'wiener_v7_final';
    let data = JSON.parse(localStorage.getItem(KEY)) || { entries: {}, weights: {} };
    let goal = parseInt(localStorage.getItem('w_goal')) || 600;
    let viewDate = new Intl.DateTimeFormat('en-CA').format(new Date());

    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

    function setDate(v) { viewDate = v; render(); }

    function shiftDate(offset) {
        let d = new Date(viewDate + 'T12:00:00');
        d.setDate(d.getDate() + offset);
        viewDate = d.toISOString().split('T')[0];
        render();
    }

    function updateWeight() {
        const w = prompt("Dog's weight on " + viewDate + ":");
        if (w && !isNaN(w)) {
            data.weights[viewDate] = w;
            save();
            render();
        }
    }

    function addEntry() {
        const n = document.getElementById('foodName');
        const c = document.getElementById('foodCals');
        if (!n.value || !c.value) return;

        if (!data.entries[viewDate]) data.entries[viewDate] = [];
        data.entries[viewDate].push({ id: Date.now(), name: n.value, cals: parseInt(c.value) });
        
        n.value = ''; c.value = '';
        save();
        animate();
        render();
    }

    function deleteItem(id) {
        data.entries[viewDate] = data.entries[viewDate].filter(i => i.id !== id);
        save();
        render();
    }

    function animate() {
        const dog = document.getElementById('runningDog');
        dog.style.left = "110%";
        setTimeout(() => { dog.style.transition = "none"; dog.style.left = "-60px"; }, 2000);
        setTimeout(() => { dog.style.transition = "left 2s linear"; }, 2100);
    }

    // This is the core "History" logic
    function getWeightForDate(targetDate) {
        if (data.weights[targetDate]) return data.weights[targetDate];
        
        // If not found, look at all dates, sort them, and find the closest one BEFORE targetDate
        const sortedDates = Object.keys(data.weights).sort();
        let lastKnown = "--";
        for (let date of sortedDates) {
            if (date <= targetDate) {
                lastKnown = data.weights[date];
            } else {
                break;
            }
        }
        return lastKnown;
    }

    function render() {
        document.getElementById('datePicker').value = viewDate;
        
        // Calories Logic
        const todayEntries = data.entries[viewDate] || [];
        const total = todayEntries.reduce((s, i) => s + i.cals, 0);
        const rem = goal - total;
        const disp = document.getElementById('calDisplay');
        disp.innerText = rem;
        rem < 0 ? disp.classList.add('over-limit') : disp.classList.remove('over-limit');

        // Weight Logic
        document.getElementById('weightVal').innerText = getWeightForDate(viewDate) + " lbs";
        document.getElementById('weightLabel').innerText = "Weight on " + viewDate;

        // List Logic
        const list = document.getElementById('listBody');
        list.innerHTML = todayEntries.map(i => `
            <li>
                <span>${i.name} <strong>(${i.cals} cal)</strong></span>
                <button onclick="deleteItem(${i.id})" style="border:none; color:#ccc; background:none;">‚úï</button>
            </li>
        `).join('') || '<li style="color:#ccc; font-size:12px;">No treats logged for this day.</li>';
    }

    function changeGoal() {
        const g = prompt("Daily Calorie Goal:", goal);
        if (g) { goal = parseInt(g); localStorage.setItem('w_goal', goal); render(); }
    }

    function clearEverything() {
        if(confirm("Delete all history?")) { localStorage.clear(); location.reload(); }
    }

    render();
</script>
</body>
</html>
